(function(t,u){"object"===typeof exports&&"undefined"!==typeof module?module.exports=u():"function"===typeof define&&define.amd?define(u):(t=t||self,t.Tribute=u())})(this,function(){function t(f,a){if(!(f instanceof a))throw new TypeError("Cannot call a class as a function");}function u(f,a){for(var b=0;b<a.length;b++){var c=a[b];c.enumerable=c.enumerable||!1;c.configurable=!0;"value"in c&&(c.writable=!0);Object.defineProperty(f,c.key,c)}}function v(f,a,b){a&&u(f.prototype,a);b&&u(f,b);return f}function x(f,
a){if(null==a||a>f.length)a=f.length;for(var b=0,c=Array(a);b<a;b++)c[b]=f[b];return c}Array.prototype.find||(Array.prototype.find=function(f,a){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!==typeof f)throw new TypeError("predicate must be a function");for(var b=Object(this),c=b.length>>>0,d,e=0;e<c;e++)if(d=b[e],f.call(a,d,e,b))return d});if(window&&"function"!==typeof window.CustomEvent){var y=function(f,a){a=a||{bubbles:!1,cancelable:!1,detail:void 0};
var b=document.createEvent("CustomEvent");b.initCustomEvent(f,a.bubbles,a.cancelable,a.detail);return b};"undefined"!==typeof window.Event&&(y.prototype=window.Event.prototype);window.CustomEvent=y}var H=function(){function f(a){t(this,f);this.tribute=a;this.tribute.events=this}v(f,[{key:"bind",value:function(a){a.boundKeydown=this.keydown.bind(a,this);a.boundKeyup=this.keyup.bind(a,this);a.boundInput=this.input.bind(a,this);a.addEventListener("keydown",a.boundKeydown,!1);a.addEventListener("keyup",
a.boundKeyup,!1);a.addEventListener("input",a.boundInput,!1)}},{key:"unbind",value:function(a){a.removeEventListener("keydown",a.boundKeydown,!1);a.removeEventListener("keyup",a.boundKeyup,!1);a.removeEventListener("input",a.boundInput,!1);delete a.boundKeydown;delete a.boundKeyup;delete a.boundInput}},{key:"keydown",value:function(a,b){a.shouldDeactivate(b)&&(a.tribute.isActive=!1,a.tribute.hideMenu());var c=this;a.commandEvent=!1;f.keys().forEach(function(d){d.key===b.keyCode&&(a.commandEvent=!0,
a.callbacks()[d.value.toLowerCase()](b,c))})}},{key:"input",value:function(a,b){a.inputEvent=!0;a.keyup.call(this,a,b)}},{key:"click",value:function(a,b){var c=a.tribute;if(c.menu&&c.menu.contains(b.target)){var d=b.target;b.preventDefault();for(b.stopPropagation();"li"!==d.nodeName.toLowerCase()&&(d=d.parentNode,d);)if(d===c.menu)throw Error("cannot find the \x3cli\x3e container for the click");d&&(c.selectItemAtIndex(d.getAttribute("data-index"),b),c.hideMenu())}else c.current.element&&!c.current.externalTrigger&&
(c.current.externalTrigger=!1,setTimeout(function(){return c.hideMenu()}))}},{key:"keyup",value:function(a,b){a.inputEvent&&(a.inputEvent=!1);a.updateSelection(this);if(27!==b.keyCode)if(!a.tribute.allowSpaces&&a.tribute.hasTrailingSpace)a.tribute.hasTrailingSpace=!1,a.commandEvent=!0,a.callbacks().space(b,this);else{if(!a.tribute.isActive)if(a.tribute.autocompleteMode)a.callbacks().triggerChar(b,this,"");else{var c=a.getKeyCode(a,this,b);if(isNaN(c)||!c)return;var d=a.tribute.triggers().find(function(a){return a.charCodeAt(0)===
c});"undefined"!==typeof d&&a.callbacks().triggerChar(b,this,d)}a.tribute.current.mentionText.length<a.tribute.current.collection.menuShowMinLength||((a.tribute.current.trigger||a.tribute.autocompleteMode)&&!1===a.commandEvent||a.tribute.isActive&&8===b.keyCode)&&a.tribute.showMenuFor(this,!0)}}},{key:"shouldDeactivate",value:function(a){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){var b=!1;f.keys().forEach(function(c){a.keyCode===c.key&&(b=!0)});return!b}return!1}},
{key:"getKeyCode",value:function(a,b,c){a=a.tribute;return(a=a.range.getTriggerInfo(!1,a.hasTrailingSpace,!0,a.allowSpaces,a.autocompleteMode))?a.mentionTriggerChar.charCodeAt(0):!1}},{key:"updateSelection",value:function(a){this.tribute.current.element=a;if(a=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode))this.tribute.current.selectedPath=a.mentionSelectedPath,this.tribute.current.mentionText=a.mentionText,this.tribute.current.selectedOffset=
a.mentionSelectedOffset}},{key:"callbacks",value:function(){var a=this;return{triggerChar:function(b,c,d){b=a.tribute;b.current.trigger=d;var e=b.collection.find(function(a){return a.trigger===d});b.current.collection=e;b.current.mentionText.length>=b.current.collection.menuShowMinLength&&b.inputEvent&&b.showMenuFor(c,!0)},enter:function(b,c){a.tribute.isActive&&a.tribute.current.filteredItems&&(b.preventDefault(),b.stopPropagation(),setTimeout(function(){a.tribute.selectItemAtIndex(a.tribute.menuSelected,
b);a.tribute.hideMenu()},0))},escape:function(b,c){a.tribute.isActive&&(b.preventDefault(),b.stopPropagation(),a.tribute.isActive=!1,a.tribute.hideMenu())},tab:function(b,c){a.callbacks().enter(b,c)},space:function(b,c){a.tribute.isActive&&(a.tribute.spaceSelectsMatch?a.callbacks().enter(b,c):a.tribute.allowSpaces||(b.stopPropagation(),setTimeout(function(){a.tribute.hideMenu();a.tribute.isActive=!1},0)))},up:function(b,c){if(a.tribute.isActive&&a.tribute.current.filteredItems){b.preventDefault();
b.stopPropagation();var d=a.tribute.current.filteredItems.length,e=a.tribute.menuSelected;d>e&&0<e?(a.tribute.menuSelected--,a.setActiveLi()):0===e&&(a.tribute.menuSelected=d-1,a.setActiveLi(),a.tribute.menu.scrollTop=a.tribute.menu.scrollHeight)}},down:function(b,c){if(a.tribute.isActive&&a.tribute.current.filteredItems){b.preventDefault();b.stopPropagation();var d=a.tribute.current.filteredItems.length-1,e=a.tribute.menuSelected;d>e?(a.tribute.menuSelected++,a.setActiveLi()):d===e&&(a.tribute.menuSelected=
0,a.setActiveLi(),a.tribute.menu.scrollTop=0)}},"delete":function(b,c){a.tribute.isActive&&1>a.tribute.current.mentionText.length?a.tribute.hideMenu():a.tribute.isActive&&a.tribute.showMenuFor(c)}}}},{key:"setActiveLi",value:function(a){var b=this.tribute.menu.querySelectorAll("li"),c=b.length>>>0;a&&(this.tribute.menuSelected=parseInt(a));for(a=0;a<c;a++){var d=b[a];if(a===this.tribute.menuSelected){d.classList.add(this.tribute.current.collection.selectClass);var d=d.getBoundingClientRect(),e=this.tribute.menu.getBoundingClientRect();
d.bottom>e.bottom?this.tribute.menu.scrollTop+=d.bottom-e.bottom:d.top<e.top&&(this.tribute.menu.scrollTop-=e.top-d.top)}else d.classList.remove(this.tribute.current.collection.selectClass)}}},{key:"getFullHeight",value:function(a,b){var c=a.getBoundingClientRect().height;if(b){var d=a.currentStyle||window.getComputedStyle(a);return c+parseFloat(d.marginTop)+parseFloat(d.marginBottom)}return c}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},
{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]);return f}(),I=function(){function f(a){t(this,f);this.tribute=a;this.tribute.menuEvents=this;this.menu=this.tribute.menu}v(f,[{key:"bind",value:function(a){var b=this;this.menuClickEvent=this.tribute.events.click.bind(null,this);this.menuContainerScrollEvent=this.debounce(function(){b.tribute.isActive&&b.tribute.showMenuFor(b.tribute.current.element,!1)},300,!1);this.windowResizeEvent=this.debounce(function(){b.tribute.isActive&&
b.tribute.range.positionMenuAtCaret(!0)},300,!1);this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1);this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1);window.addEventListener("resize",this.windowResizeEvent);this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}},{key:"unbind",value:function(a){this.tribute.range.getDocument().removeEventListener("mousedown",
this.menuClickEvent,!1);this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1);window.removeEventListener("resize",this.windowResizeEvent);this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}},{key:"debounce",value:function(a,b,c){var d=arguments,e=this,g;return function(){var h=e,k=d,f=c&&!g;clearTimeout(g);g=setTimeout(function(){g=null;c||a.apply(h,
k)},b);f&&a.apply(h,k)}}}]);return f}(),J=function(){function f(a){t(this,f);this.tribute=a;this.tribute.range=this}v(f,[{key:"getDocument",value:function(){var a;this.tribute.current.collection&&(a=this.tribute.current.collection.iframe);return a?a.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(a){var b=this,c=this.tribute.current,d;d=void 0;var e;d=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);"undefined"!==
typeof d?this.tribute.positionMenu?(e=this.isContentEditable(c.element)?this.getContentEditableCaretPosition(d.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,d.mentionPosition),"undefined"!==typeof CKEDITOR&&"undefined"!==typeof CKEDITOR.instances?(c=$.map(CKEDITOR.instances,function(a,b){return b})[0],"object"!==typeof CKEDITOR.instances[c]&&(this.tribute.menu.style.cssText="top: "+e.top+"px;\n                                     left: "+e.left+"px;\n                                     right: "+
e.right+"px;\n                                     bottom: "+e.bottom+"px;\n                                     position: absolute;\n                                     zIndex: 10000;\n                                     display: block;"),"wysiwyg"==CKEDITOR.instances[c].mode?(d=CKEDITOR.instances[c].container.$.parentElement.getBoundingClientRect(),c=CKEDITOR.instances[c].container.$.childNodes[0].childNodes[0].offsetHeight,c=e.top+d.top+c,d=e.left+d.left,this.tribute.menu.style.cssText="top: "+
c+"px;\n                                     left: "+d+"px;\n                                     right: "+e.right+"px;\n                                     bottom: "+e.bottom+"px;\n                                     position: absolute;\n                                     zIndex: 10000;\n                                     display: block;"):this.tribute.menu.style.cssText="top: "+e.top+"px;\n                                     left: "+e.left+"px;\n                                     right: "+
e.right+"px;\n                                     bottom: "+e.bottom+"px;\n                                     position: absolute;\n                                     zIndex: 10000;\n                                     display: block;"):this.tribute.menu.style.cssText="top: "+e.top+"px;\n                                     left: "+e.left+"px;\n                                     right: "+e.right+"px;\n                                     bottom: "+e.bottom+"px;\n                                     position: absolute;\n                                     zIndex: 10000;\n                                     display: block;",
"auto"===e.left&&(this.tribute.menu.style.left="auto"),"auto"===e.top&&(this.tribute.menu.style.top="auto"),a&&this.scrollIntoView(),window.setTimeout(function(){var c={width:b.tribute.menu.offsetWidth,height:b.tribute.menu.offsetHeight},d=b.isMenuOffScreen(e,c),k=window.innerHeight>c.height&&(d.top||d.bottom);if(window.innerWidth>c.width&&(d.left||d.right)||k)b.tribute.menu.style.cssText="display: none",b.positionMenuAtCaret(a)},0)):this.tribute.menu.style.cssText="display: block;":this.tribute.menu.style.cssText=
"display: none"}},{key:"selectElement",value:function(a,b,c){var d=a;if(b)for(var e=0;e<b.length;e++){d=d.childNodes[b[e]];if(void 0===d)return;for(;d.length<c;)c-=d.length,d=d.nextSibling;0!==d.childNodes.length||d.length||(d=d.previousSibling)}e=this.getWindowSelection();b=this.getDocument().createRange();b.setStart(d,c);b.setEnd(d,c);b.collapse(!0);try{e.removeAllRanges()}catch(g){}e.addRange(b);a.focus()}},{key:"replaceTriggerText",value:function(a,b,c,d,e){b=this.getTriggerInfo(!0,c,b,this.tribute.allowSpaces,
this.tribute.autocompleteMode);if(void 0!==b){c=this.tribute.current;d=new CustomEvent("tribute-replaced",{detail:{item:e,instance:c,context:b,event:d}});if(this.isContentEditable(c.element))a+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ",e=b.mentionPosition+b.mentionText.length,this.tribute.autocompleteMode||(e+=b.mentionTriggerChar.length),this.pasteHtml(a,b.mentionPosition,e);else{e=this.tribute.current.element;var g="string"==typeof this.tribute.replaceTextSuffix?
this.tribute.replaceTextSuffix:" ";a+=g;var h=b.mentionPosition,g=b.mentionPosition+b.mentionText.length+g.length;this.tribute.autocompleteMode||(g+=b.mentionTriggerChar.length-1);e.value=e.value.substring(0,h)+a+e.value.substring(g,e.value.length);e.selectionStart=h+a.length;e.selectionEnd=h+a.length}c.element.dispatchEvent(new CustomEvent("input",{bubbles:!0}));c.element.dispatchEvent(d)}}},{key:"pasteHtml",value:function(a,b,c){var d,e;e=this.getWindowSelection();d=this.getDocument().createRange();
d.setStart(e.anchorNode,b);d.setEnd(e.anchorNode,c);d.deleteContents();b=this.getDocument().createElement("div");b.innerHTML=a;a=this.getDocument().createDocumentFragment();for(var g;c=b.firstChild;)g=a.appendChild(c);d.insertNode(a);g&&(d=d.cloneRange(),d.setStartAfter(g),d.collapse(!0),e.removeAllRanges(),e.addRange(d))}},{key:"getWindowSelection",value:function(){var a;return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():"undefined"!==typeof CKEDITOR&&
"undefined"!==typeof CKEDITOR.instances?(a=$.map(CKEDITOR.instances,function(a,c){return c})[0],"object"!==typeof CKEDITOR.instances[a]?window.getSelection():CKEDITOR.instances[a].getSelection().getNative()):window.getSelection()}},{key:"getNodePositionInParent",value:function(a){if(null===a.parentNode)return 0;for(var b=0;b<a.parentNode.childNodes.length;b++)if(a.parentNode.childNodes[b]===a)return b}},{key:"getContentEditableSelectedPath",value:function(a){var b=this.getWindowSelection();a=b.anchorNode;
var c=[];if(null!=a){for(var d,e=a.contentEditable;null!==a&&"true"!==e;)d=this.getNodePositionInParent(a),c.push(d),a=a.parentNode,null!==a&&(e=a.contentEditable);c.reverse();b=b.getRangeAt(0).startOffset;return{selected:a,path:c,offset:b}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var a="";if(this.isContentEditable(this.tribute.current.element)){var b=this.getWindowSelection().anchorNode;if(null!=b){var b=b.textContent,c=this.getWindowSelection().getRangeAt(0).startOffset;b&&0<=
c&&(a=b.substring(0,c))}}else if(b=this.tribute.current.element)c=b.selectionStart,b.value&&0<=c&&(a=b.value.substring(0,c));return a}},{key:"getLastWordInText",value:function(a){a=a.replace(/\u00A0/g," ");a=this.tribute.autocompleteSeparator?a.split(this.tribute.autocompleteSeparator):a.split(/\s+/);return a[a.length-1].trim()}},{key:"getTriggerInfo",value:function(a,b,c,d,e){var g=this,h=this.tribute.current,k,f,m;if(this.isContentEditable(h.element)){if(h=this.getContentEditableSelectedPath(h))k=
h.selected,f=h.path,m=h.offset}else k=this.tribute.current.element;var n=this.getTextPrecedingCurrentSelection(),h=this.getLastWordInText(n);if(e)return{mentionPosition:n.length-h.length,mentionText:h,mentionSelectedElement:k,mentionSelectedPath:f,mentionSelectedOffset:m};if(void 0!==n&&null!==n){var l=-1,q;this.tribute.collection.forEach(function(a){var b=a.trigger,e=a.requireLeadingSpace?g.lastIndexWithLeadingSpace(n,b):n.lastIndexOf(b);e>l&&(l=e,q=b,c=a.requireLeadingSpace)});if(0<=l&&(0===l||
!c||/[\xA0\s]/g.test(n.substring(l-1,l)))&&(e=n.substring(l+q.length,n.length),q=n.substring(l,l+q.length),h=e.substring(0,1),h=0<e.length&&(" "===h||" "===h),b&&(e=e.trim()),b=d?/[^\S ]/g:/[\xA0\s]/g,this.tribute.hasTrailingSpace=b.test(e),!h&&(a||!b.test(e))))return{mentionPosition:l,mentionText:e,mentionSelectedElement:k,mentionSelectedPath:f,mentionSelectedOffset:m,mentionTriggerChar:q}}}},{key:"lastIndexWithLeadingSpace",value:function(a,b){for(var c=a.split("").reverse().join(""),d=-1,e=0,g=
a.length;e<g;e++){for(var h=e===a.length-1,f=/\s/.test(c[e+1]),p=!0,m=b.length-1;0<=m;m--)if(b[m]!==c[e-m]){p=!1;break}if(p&&(h||f)){d=a.length-1-e;break}}return d}},{key:"isContentEditable",value:function(a){return"INPUT"!==a.nodeName&&"TEXTAREA"!==a.nodeName}},{key:"isMenuOffScreen",value:function(a,b){var c=window.innerWidth,d=window.innerHeight,e=document.documentElement,g=(window.pageXOffset||e.scrollLeft)-(e.clientLeft||0),e=(window.pageYOffset||e.scrollTop)-(e.clientTop||0),h="number"===typeof a.bottom?
a.bottom:a.top+b.height,f="number"===typeof a.left?a.left:g+c-a.right-b.width;return{top:("number"===typeof a.top?a.top:e+d-a.bottom-b.height)<Math.floor(e),right:("number"===typeof a.right?a.right:a.left+b.width)>Math.ceil(g+c),bottom:h>Math.ceil(e+d),left:f<Math.floor(g)}}},{key:"getMenuDimensions",value:function(){var a={width:null,height:null};this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;";
a.width=this.tribute.menu.offsetWidth;a.height=this.tribute.menu.offsetHeight;this.tribute.menu.style.cssText="display: none;";return a}},{key:"getTextAreaOrInputUnderlinePosition",value:function(a,b,c){var d=null!==window.mozInnerScreenX;c=this.getDocument().createElement("div");c.id="input-textarea-caret-position-mirror-div";this.getDocument().body.appendChild(c);var e=c.style,g=window.getComputedStyle?getComputedStyle(a):a.currentStyle;e.whiteSpace="pre-wrap";"INPUT"!==a.nodeName&&(e.wordWrap=
"break-word");e.position="absolute";e.visibility="hidden";"direction boxSizing width height overflowX overflowY borderTopWidth borderRightWidth borderBottomWidth borderLeftWidth paddingTop paddingRight paddingBottom paddingLeft fontStyle fontVariant fontWeight fontStretch fontSize fontSizeAdjust lineHeight fontFamily textAlign textTransform textIndent textDecoration letterSpacing wordSpacing".split(" ").forEach(function(a){e[a]=g[a]});d?(e.width="".concat(parseInt(g.width)-2,"px"),a.scrollHeight>
parseInt(g.height)&&(e.overflowY="scroll")):e.overflow="hidden";c.textContent=a.value.substring(0,b);"INPUT"===a.nodeName&&(c.textContent=c.textContent.replace(/\s/g," "));d=this.getDocument().createElement("span");d.textContent=a.value.substring(b)||".";c.appendChild(d);b=a.getBoundingClientRect();var h=document.documentElement,f=(window.pageXOffset||h.scrollLeft)-(h.clientLeft||0),h=(window.pageYOffset||h.scrollTop)-(h.clientTop||0),p=0,m=0;this.menuContainerIsBody&&(p=b.top,m=b.left);a={top:p+
h+d.offsetTop+parseInt(g.borderTopWidth)+parseInt(g.fontSize)-a.scrollTop,left:m+f+d.offsetLeft+parseInt(g.borderLeftWidth)};var p=window.innerWidth,m=window.innerHeight,n=this.getMenuDimensions(),l=this.isMenuOffScreen(a,n);l.right&&(a.right=p-a.left,a.left="auto");var q=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;l.bottom&&(l=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),
a.bottom=q-(m-l.top)+(m-b.top-d.offsetTop),a.top="auto");l=this.isMenuOffScreen(a,n);l.left&&(a.left=p>n.width?f+p-n.width:f,delete a.right);l.top&&(a.top=m>n.height?h+m-n.height:h,delete a.bottom);this.getDocument().body.removeChild(c);return a}},{key:"getContentEditableCaretPosition",value:function(a){var b,c=this.getWindowSelection();b=this.getDocument().createRange();b.setStart(c.anchorNode,a);b.setEnd(c.anchorNode,a);b.collapse(!1);a=b.getBoundingClientRect();c=document.documentElement;b=(window.pageXOffset||
c.scrollLeft)-(c.clientLeft||0);var c=(window.pageYOffset||c.scrollTop)-(c.clientTop||0),d={left:a.left+b,top:a.top+a.height+c},e=window.innerWidth,g=window.innerHeight,h=this.getMenuDimensions(),f=this.isMenuOffScreen(d,h);f.right&&(d.left="auto",d.right=e-a.left-b);var p=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;f.bottom&&(f=this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect(),
p-=g-f.top,d.top="auto",d.bottom=p+(g-a.top));f=this.isMenuOffScreen(d,h);f.left&&(d.left=e>h.width?b+e-h.width:b,delete d.right);f.top&&(d.top=g>h.height?c+g-h.height:c,delete d.bottom);this.menuContainerIsBody||(d.left=d.left?d.left-this.tribute.menuContainer.offsetLeft:d.left,d.top=d.top?d.top-this.tribute.menuContainer.offsetTop:d.top);return d}},{key:"scrollIntoView",value:function(a){var b;a=this.menu;if("undefined"!==typeof a){for(;void 0===b||0===b.height;)if(b=a.getBoundingClientRect(),0===
b.height&&(a=a.childNodes[0],void 0===a||!a.getBoundingClientRect))return;var c=b.top;a=c+b.height;0>c?window.scrollTo(0,window.pageYOffset+b.top-20):a>window.innerHeight&&(b=window.pageYOffset+b.top-20,100<b-window.pageYOffset&&(b=window.pageYOffset+100),a=window.pageYOffset-(window.innerHeight-a),a>b&&(a=b),window.scrollTo(0,a))}}},{key:"menuContainerIsBody",get:function(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}}]);return f}(),K=function(){function f(a){t(this,
f);this.tribute=a;this.tribute.search=this}v(f,[{key:"simpleFilter",value:function(a,b){var c=this;return b.filter(function(b){return c.test(a,b)})}},{key:"test",value:function(a,b){return null!==this.match(a,b)}},{key:"match",value:function(a,b,c){c=c||{};var d=c.pre||"",e=c.post||"",f=c.caseSensitive&&b||b.toLowerCase();if(c.skip)return{rendered:b,score:0};a=c.caseSensitive&&a||a.toLowerCase();return(a=this.traverse(f,a,0,0,[]))?{rendered:this.render(b,a.cache,d,e),score:a.score}:null}},{key:"traverse",
value:function(a,b,c,d,e){this.tribute.autocompleteSeparator&&(b=b.split(this.tribute.autocompleteSeparator).splice(-1)[0]);if(b.length===d)return{score:this.calculateScore(e),cache:e.slice()};if(!(a.length===c||b.length-d>a.length-c)){var f=b[d];c=a.indexOf(f,c);for(var h,k;-1<c;){e.push(c);k=this.traverse(a,b,c+1,d+1,e);e.pop();if(!k)break;if(!h||h.score<k.score)h=k;c=a.indexOf(f,c+1)}return h}}},{key:"calculateScore",value:function(a){var b=0,c=1;a.forEach(function(d,e){0<e&&(c=a[e-1]+1===d?c+
(c+1):1);b+=c});return b}},{key:"render",value:function(a,b,c,d){var e=a.substring(0,b[0]);b.forEach(function(f,h){e+=c+a[f]+d+a.substring(f+1,b[h+1]?b[h+1]:a.length)});return e}},{key:"filter",value:function(a,b,c){var d=this;c=c||{};return b.reduce(function(b,f,h,k){k=f;c.extract&&((k=c.extract(f))||(k=""));k=d.match(a,k,c);null!=k&&(b[b.length]={string:k.rendered,score:k.score,index:h,original:f});return b},[]).sort(function(a,b){var c=b.score-a.score;return c?c:a.index-b.index})}}]);return f}();
return function(){function f(a){var b=this,c=a.values,c=void 0===c?null:c,d=a.loadingItemTemplate,d=void 0===d?null:d,e=a.iframe,g=void 0===e?null:e,e=a.selectClass,h=void 0===e?"highlight":e,e=a.containerClass,k=void 0===e?"tribute-container":e,e=a.itemClass,p=void 0===e?"":e,e=a.trigger,m=void 0===e?"@":e,e=a.autocompleteMode,e=void 0===e?!1:e,n=a.autocompleteSeparator,n=void 0===n?null:n,l=a.selectTemplate,l=void 0===l?null:l,q=a.menuItemTemplate,q=void 0===q?null:q,r=a.lookup,u=void 0===r?"key":
r,r=a.fillAttr,v=void 0===r?"value":r,r=a.collection,r=void 0===r?null:r,B=a.menuContainer,B=void 0===B?null:B,w=a.noMatchTemplate,C=void 0===w?null:w,w=a.requireLeadingSpace,w=void 0===w?!0:w,z=a.allowSpaces,z=void 0===z?!1:z,D=a.replaceTextSuffix,D=void 0===D?null:D,E=a.positionMenu,E=void 0===E?!0:E,F=a.spaceSelectsMatch,F=void 0===F?!1:F,A=a.searchOpts,x=void 0===A?{}:A,A=a.menuItemLimit,y=void 0===A?null:A;a=a.menuShowMinLength;var G=void 0===a?0:a;t(this,f);this.autocompleteMode=e;this.autocompleteSeparator=
n;this.menuSelected=0;this.current={};this.isActive=this.inputEvent=!1;this.menuContainer=B;this.allowSpaces=z;this.replaceTextSuffix=D;this.positionMenu=E;this.hasTrailingSpace=!1;this.spaceSelectsMatch=F;this.autocompleteMode&&(m="",z=!1);if(c)this.collection=[{trigger:m,iframe:g,selectClass:h,containerClass:k,itemClass:p,selectTemplate:(l||f.defaultSelectTemplate).bind(this),menuItemTemplate:(q||f.defaultMenuItemTemplate).bind(this),noMatchTemplate:function(a){return"string"===typeof a?""===a.trim()?
null:a:"function"===typeof a?a.bind(b):C||function(){return"\x3cli\x3eNo Match Found!\x3c/li\x3e"}.bind(b)}(C),lookup:u,fillAttr:v,values:c,loadingItemTemplate:d,requireLeadingSpace:w,searchOpts:x,menuItemLimit:y,menuShowMinLength:G}];else if(r)this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=r.map(function(a){return{trigger:a.trigger||m,iframe:a.iframe||g,selectClass:a.selectClass||h,containerClass:a.containerClass||k,itemClass:a.itemClass||
p,selectTemplate:(a.selectTemplate||f.defaultSelectTemplate).bind(b),menuItemTemplate:(a.menuItemTemplate||f.defaultMenuItemTemplate).bind(b),noMatchTemplate:function(a){return"string"===typeof a?""===a.trim()?null:a:"function"===typeof a?a.bind(b):C||function(){return"\x3cli\x3eNo Match Found!\x3c/li\x3e"}.bind(b)}(C),lookup:a.lookup||u,fillAttr:a.fillAttr||v,values:a.values,loadingItemTemplate:a.loadingItemTemplate,requireLeadingSpace:a.requireLeadingSpace,searchOpts:a.searchOpts||x,menuItemLimit:a.menuItemLimit||
y,menuShowMinLength:a.menuShowMinLength||G}});else throw Error("[Tribute] No collection specified.");new J(this);new H(this);new I(this);new K(this)}v(f,[{key:"triggers",value:function(){return this.collection.map(function(a){return a.trigger})}},{key:"attach",value:function(a){if(!a)throw Error("[Tribute] Must pass in a DOM node or NodeList.");"undefined"!==typeof jQuery&&a instanceof jQuery&&(a=a.get());if(a.constructor===NodeList||a.constructor===HTMLCollection||a.constructor===Array)for(var b=
a.length,c=0;c<b;++c)this._attach(a[c]);else this._attach(a)}},{key:"_attach",value:function(a){a.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+a.nodeName);this.ensureEditable(a);this.events.bind(a);a.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(a){if(-1===f.inputTypes().indexOf(a.nodeName))if(a.contentEditable)a.contentEditable=!0;else throw Error("[Tribute] Cannot bind to "+a.nodeName);}},{key:"createMenu",value:function(a){var b=this.range.getDocument().createElement("div"),
c=this.range.getDocument().createElement("ul");b.className=a;b.appendChild(c);return this.menuContainer?this.menuContainer.appendChild(b):this.range.getDocument().body.appendChild(b)}},{key:"showMenuFor",value:function(a,b){var c=this;if(!this.isActive||this.current.element!==a||this.current.mentionText!==this.currentMentionTextSnapshot){this.currentMentionTextSnapshot=this.current.mentionText;this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),a.tributeMenu=this.menu,this.menuEvents.bind(this.menu));
this.isActive=!0;this.menuSelected=0;this.current.mentionText||(this.current.mentionText="");var d=function(a){if(c.isActive){var d=c.search.filter(c.current.mentionText,a,{pre:c.current.collection.searchOpts.pre||"\x3cspan\x3e",post:c.current.collection.searchOpts.post||"\x3c/span\x3e",skip:c.current.collection.searchOpts.skip,extract:function(a){if("string"===typeof c.current.collection.lookup)return a[c.current.collection.lookup];if("function"===typeof c.current.collection.lookup)return c.current.collection.lookup(a,
c.current.mentionText);throw Error("Invalid lookup attribute, lookup must be string or function.");}});c.current.collection.menuItemLimit&&(d=d.slice(0,c.current.collection.menuItemLimit));c.current.filteredItems=d;a=c.menu.querySelector("ul");c.range.positionMenuAtCaret(b);if(d.length){a.innerHTML="";var f=c.range.getDocument().createDocumentFragment();d.forEach(function(a,b){var d=c.range.getDocument().createElement("li");d.setAttribute("data-index",b);d.className=c.current.collection.itemClass;
d.addEventListener("mousemove",function(a){var b=c._findLiTarget(a.target),d;d=Array.isArray(b)?b:void 0;if(!d)if("undefined"!==typeof Symbol&&Symbol.iterator in Object(b)){d=[];var e=!0,f=!1,h=void 0;try{for(var g=b[Symbol.iterator](),k;!(e=(k=g.next()).done)&&(d.push(k.value),2!==d.length);e=!0);}catch(m){f=!0,h=m}finally{try{if(!e&&null!=g["return"])g["return"]()}finally{if(f)throw h;}}}else d=void 0;if(!(g=d))a:{if(b){if("string"===typeof b){g=x(b,2);break a}g=Object.prototype.toString.call(b).slice(8,
-1);"Object"===g&&b.constructor&&(g=b.constructor.name);if("Map"===g||"Set"===g){g=Array.from(g);break a}if("Arguments"===g||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(g)){g=x(b,2);break a}}g=void 0}if(!(b=g))throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");b=b[1];0!==a.movementY&&c.events.setActiveLi(b)});c.menuSelected===b&&d.classList.add(c.current.collection.selectClass);d.innerHTML=
c.current.collection.menuItemTemplate(a);f.appendChild(d)});a.appendChild(f)}else d=new CustomEvent("tribute-no-match",{detail:c.menu}),c.current.element.dispatchEvent(d),"function"===typeof c.current.collection.noMatchTemplate&&!c.current.collection.noMatchTemplate()||!c.current.collection.noMatchTemplate?c.hideMenu():"function"===typeof c.current.collection.noMatchTemplate?a.innerHTML=c.current.collection.noMatchTemplate():a.innerHTML=c.current.collection.noMatchTemplate}};"function"===typeof this.current.collection.values?
(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(b)),this.current.collection.values(this.current.mentionText,d)):d(this.current.collection.values)}}},{key:"_findLiTarget",value:function(a){if(!a)return[];var b=a.getAttribute("data-index");return b?[a,b]:this._findLiTarget(a.parentNode)}},{key:"showMenuForCollection",value:function(a,b){a!==document.activeElement&&this.placeCaretAtEnd(a);
this.current.collection=this.collection[b||0];this.current.externalTrigger=!0;this.current.element=a;a.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(a,this.current.collection.trigger);this.showMenuFor(a)}},{key:"placeCaretAtEnd",value:function(a){a.focus();if("undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var b=document.createRange();b.selectNodeContents(a);b.collapse(!1);a=window.getSelection();a.removeAllRanges();
a.addRange(b)}else"undefined"!=typeof document.body.createTextRange&&(b=document.body.createTextRange(),b.moveToElementText(a),b.collapse(!1),b.select())}},{key:"insertTextAtCursor",value:function(a){var b,c;b=window.getSelection();c=b.getRangeAt(0);c.deleteContents();a=document.createTextNode(a);c.insertNode(a);c.selectNodeContents(a);c.collapse(!1);b.removeAllRanges();b.addRange(c)}},{key:"insertAtCaret",value:function(a,b){var c=a.scrollTop,d=a.selectionStart,e=a.value.substring(0,d),f=a.value.substring(a.selectionEnd,
a.value.length);a.value=e+b+f;d+=b.length;a.selectionStart=d;a.selectionEnd=d;a.focus();a.scrollTop=c}},{key:"hideMenu",value:function(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}},{key:"selectItemAtIndex",value:function(a,b){a=parseInt(a);if("number"===typeof a&&!isNaN(a)){var c=this.current.filteredItems[a],d=this.current.collection.selectTemplate(c);null!==d&&this.replaceText(d,b,c)}}},{key:"replaceText",value:function(a,b,c){this.range.replaceTriggerText(a,
!0,!0,b,c)}},{key:"_append",value:function(a,b,c){if("function"===typeof a.values)throw Error("Unable to append to values, as it is a function.");a.values=c?b:a.values.concat(b)}},{key:"append",value:function(a,b,c){a=parseInt(a);if("number"!==typeof a)throw Error("please provide an index for the collection to update.");this._append(this.collection[a],b,c)}},{key:"appendCurrent",value:function(a,b){if(this.isActive)this._append(this.current.collection,a,b);else throw Error("No active state. Please use append instead and pass an index.");
}},{key:"detach",value:function(a){if(!a)throw Error("[Tribute] Must pass in a DOM node or NodeList.");"undefined"!==typeof jQuery&&a instanceof jQuery&&(a=a.get());if(a.constructor===NodeList||a.constructor===HTMLCollection||a.constructor===Array)for(var b=a.length,c=0;c<b;++c)this._detach(a[c]);else this._detach(a)}},{key:"_detach",value:function(a){var b=this;this.events.unbind(a);a.tributeMenu&&this.menuEvents.unbind(a.tributeMenu);setTimeout(function(){a.removeAttribute("data-tribute");b.isActive=
!1;a.tributeMenu&&a.tributeMenu.remove()})}},{key:"isActive",get:function(){return this._isActive},set:function(a){this._isActive!=a&&(this._isActive=a,this.current.element&&(a=new CustomEvent("tribute-active-".concat(a)),this.current.element.dispatchEvent(a)))}}],[{key:"defaultSelectTemplate",value:function(a){return"undefined"===typeof a?"".concat(this.current.collection.trigger).concat(this.current.mentionText):this.range.isContentEditable(this.current.element)?'\x3cspan class\x3d"tribute-mention"\x3e'+
(this.current.collection.trigger+a.original[this.current.collection.fillAttr])+"\x3c/span\x3e":this.current.collection.trigger+a.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(a){return a.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]);return f}()});